<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="iris-prebook">
  <template>
    <style>
      :host {
        display: block;
      }
      
      .picker {
        @apply(--layout);
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      
      .picker paper-icon-button {
        color: var(--mydoc-brown-800);
        border: 2px solid var(--mydoc-brown-800);
        border-radius: 50%;
      }
    </style>
    <iris-shared-entities id="timezone" namespace="timezone"></iris-shared-entities>
    <div class="day-picker picker">
      <paper-icon-button icon="chevron-left" id="previous-week" on-click="previousWeek" disabled$="[[canPrevWeek(slots,currentWeek)]]" raised></paper-icon-button>
      <div class="days">
        <template is="dom-repeat" items="[[days]]">
          <paper-button disabled$="[[!item.is_available ]]" on-click="selectDay" raised noink>
            <div class="day">[[getDay(item)]]</div>
            <div class="date">[[getDate(item)]]</div>
          </paper-button>
        </template>
      </div>
      <paper-icon-button icon="chevron-right" id="next-week" on-click="nextWeek" disabled$="[[canNextWeek(slots,currentWeek)]]" raised></paper-icon-button>
    </div>

    <div class="slot-picker picker">
      <paper-icon-button icon="chevron-left" id="previous-slots" on-click="previousSlots" hidden$="[[scrollableSlots(slots)]]" disabled$="[[canPrevSlots(slots,currentSlot)]]" raised></paper-icon-button>
      <div class="days">
        <template is="dom-repeat" items="[[calcPage(slots,page)]]">
          <paper-button class="chunk" on-click="selectSlot">
            [[chunkTime(item.time_description)]]
          </paper-button>
        </template>
      </div>
      <paper-icon-button icon="chevron-right" id="next-slots" on-click="nextSlots" hidden$="[[scrollableSlots(slots)]]" disabled$="[[canNextSlots(slots,currentSlot)]]" raised></paper-icon-button>
    </div>

  </template>
  <script>
    'use strict'

    Polymer({
      is: 'iris-prebook',
      properties: {
        days: {
          type: Array
        },
        slots: {
          type: Array
        }
      },
      calcPage(slots, page) {
        let from = this.slots_per_page * page;
        let to = this.slots_per_page * (page + 1);

        return slots.slice(from, to);
      },
      ready() {
        this.timezone = this.$.timezone.get('name');
        this.slots_per_page = 8;
        this.page = 0;
        console.log(this.timezone);
        this.days = [{
          is_available: true,
          date: Date.now(),
          slots: [{
            time_description: [0, 1000]
          }]
        }, {
          is_available: false,
          date: Date.now()
        }, {
          is_available: false,
          date: Date.now()
        }, {
          is_available: true,
          date: Date.now()
        }, {
          is_available: true,
          date: Date.now()
        }];
        for (let i = 1; i < 25; i += 1) {
          this.days[0].slots.push({
            time_description: [i * 3000, (i + 1) * 3000]
          })
        }
        this.slots = this.days[0].slots
      },
      selectSlot(e) {

      },
      selectDay(e) {
        let day = e.model.id;
        console.log(e.model);
        // if (day !== currentDay)
        this.fire('select-day', day)
      },
      scrollableSlots(slots) {
        return false;
      },
      canPrevSlots(slots, currentSlot) {},
      canNextSlots(slots, currentSlot) {},
      canNextWeek(slots, currentWeek) {},
      canPrevWeek(slots, currentWeek) {},
      dayClass(item) {
        return item.active ? 'on' : 'off';
      },
      getDay(item) {
        return moment(item.date).tz(this.timezone).format('ddd');
      },
      getDate(item) {
        return moment(item.date).tz(this.timezone).format('D MMM');
      },
      previousWeek() {
        this.fire('week-change', {
          direction: 'previous',
          week: this.currentWeek
        })
      },
      nextWeek() {
        this.fire('week-change', {
          direction: 'next',
          week: this.currentWeek
        })
      },
      previousSlots() {
        this.page--;
      },
      nextSlots() {
        this.page++;
      },
      chunkTime(times) {

        return this.timeFormat(times[0]) + '-' + this.timeFormat(times[1]);
      },
      timeFormat(time) {
        let hours = _.floor(time / (60 * 60));
        let mins = _.floor((time % 3600) / 60);
        mins = mins.toString().length == 1 ? '0' + mins : mins;

        return hours + ':' + mins;
      }
    });
  </script>
</dom-module>