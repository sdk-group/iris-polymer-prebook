<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<dom-module id="iris-prebook">
  <template>
    <style>
      :host {
        display: block;
      }
      
      .picker {
        @apply(--layout);
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      
      paper-button.chunk {
        width: 150px;
        margin: 0;
      }
      
      .picker paper-icon-button {
        color: var(--mydoc-brown-800);
        border: 2px solid;
        border-radius: 50%;
      }
      
      .picker paper-icon-button[disabled] {
        @apply(--pagination-icon-buttons-disabled);
      }
      
      .slot-picker {
        width: 100%;
        display: flex;
      }
      
      #days {
        flex: 1;
        display: flex;
        flex-direction: row;
        margin: 0 15px;
        justify-content: space-between;
      }
    </style>
    <iris-shared-entities id="timezone" namespace="timezone"></iris-shared-entities>
    <div class="day-picker picker">
      <paper-icon-button icon="chevron-left" id="previous-week" on-click="previousWeek" disabled$="[[canPrevWeek(slots,currentWeek)]]" raised></paper-icon-button>
      <div class="days">
        <template is="dom-repeat" items="[[days]]">
          <paper-button disabled$="[[!item.is_available ]]" on-click="selectDay" raised noink>
            <div class="day">[[getDay(item)]]</div>
            <div class="date">[[getDate(item)]]</div>
          </paper-button>
        </template>
      </div>
      <paper-icon-button icon="chevron-right" id="next-week" on-click="nextWeek" disabled$="[[canNextWeek(slots,currentWeek)]]" raised></paper-icon-button>
    </div>

    <div class="slot-picker picker">
      <paper-icon-button icon="chevron-left" id="previous-slots" on-click="previousSlots" hidden$="[[scrollableSlots(slots)]]" disabled$="[[!canPrevSlots(page)]]" raised></paper-icon-button>
      <div id="days">
        <template is="dom-repeat" items="[[calcPage(slots,page, slots_per_page)]]">
          <paper-button class="chunk" raised on-click="selectSlot">
            [[chunkTime(item.time_description)]]
          </paper-button>
        </template>
      </div>
      <paper-icon-button icon="chevron-right" id="next-slots" on-click="nextSlots" hidden$="[[scrollableSlots(slots)]]" disabled$="[[!canNextSlots(page,slots)]]" raised></paper-icon-button>
    </div>

  </template>
  <script>
    'use strict'

    Polymer({
      is: 'iris-prebook',
      behaviors: [
        Polymer.IronResizableBehavior
      ],
      properties: {
        days: {
          type: Array
        },
        slots: {
          type: Array
        },
        selected: {
          type: Object,
          notify: true
        }
      },
      listeners: {
        'iron-resize': 'calcItemCount'
      },
      calcItemCount() {
        let width = this.$.days.offsetWidth;
        this.set('slots_per_page', _.floor(width / 160));
      },
      attached() {
        this.async(this.notifyResize, 1);
      },
      calcPage(slots, page, slots_per_page) {
        this.calcItemCount();
        let from = this.slots_per_page * page;
        let to = this.slots_per_page * (page + 1);

        return slots.slice(from, to);
      },
      ready() {

        this.slots_per_page = 8;
        this.page = 0;
      },
      selectSlot(e) {

        let item = e.model.item;
        this.set('selected', item.time_description);
      },
      selectDay(e) {
        let item = e.model.item;
        console.log('selected day:', item);

        this.fire('select-day', item)
      },
      scrollableSlots(slots) {
        return false;
      },
      canPrevSlots(page) {
        console.log('prev en', page);
        return page > 0;
      },
      canNextSlots(page, slots) {
        console.log('next en', page, this.slots_per_page);
        return this.slots ? (page + 1) * this.slots_per_page < this.slots.length : false;
      },
      canNextWeek(slots, currentWeek) {
        return true;
      },
      canPrevWeek(slots, currentWeek) {
        return true;
      },
      dayClass(item) {
        return item.active ? 'on' : 'off';
      },
      getDay(item) {
        let timezone = this.$.timezone.get('name');
        return moment(item.date).tz(timezone).format('ddd');
      },
      getDate(item) {
        let timezone = this.$.timezone.get('name');
        return moment(item.date).tz(timezone).format('D MMM');
      },
      previousWeek() {
        this.fire('week-change', {
          direction: 'previous',
          week: this.currentWeek
        })
      },
      nextWeek() {
        this.fire('week-change', {
          direction: 'next',
          week: this.currentWeek
        })
      },
      previousSlots() {
        this.page--;
      },
      nextSlots() {
        this.page++;
      },
      chunkTime(times) {

        return this.timeFormat(times[0]) + '-' + this.timeFormat(times[1]);
      },
      timeFormat(time) {
        let hours = _.floor(time / (60 * 60));
        let mins = _.floor((time % 3600) / 60);
        mins = mins.toString().length == 1 ? '0' + mins : mins;

        return hours + ':' + mins;
      }
    });
  </script>
</dom-module>